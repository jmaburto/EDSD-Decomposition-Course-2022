---
title: 'Exercise 3: Age-specific deomposition of a difference between life expectancies'
output: pdf_document
date: '2022-05-07'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The aim of this exercise is to illustrate how to decompose by age the difference between two life expectancies, using the Arriaga method. While there are many methods that would lead to similar results, the Arriaga method is the most common for this specific calculation. Specifically, we will use data from Aburto et al. (2020), analysing the change in life expectancy at birth in Slovenia and Norway between 2019 and 2020. The dataset contains the relative lifetables.

First load the data and the necessary packages. 

```{r load, message=FALSE}
load('COVIDArriaga.RData')

library(tidyverse)
```

Let's start with Slovenia. We need to extract the information needed by the Arriaga formulas from the lifetables.

```{r}
l1S<- data %>%
  filter(country=="SI", year==2019) %>% 
  pull(lx)
l2S<- data %>%
  filter(country=="SI", year==2020) %>% 
  pull(lx)
d1S<- data %>%
  filter(country=="SI", year==2019) %>% 
  pull(dx)
d2S<- data %>%
  filter(country=="SI", year==2020) %>% 
  pull(dx)
L1S<- data %>%
  filter(country=="SI", year==2019) %>% 
  pull(Lx)
L2S<- data %>%
  filter(country=="SI", year==2020) %>% 
  pull(Lx)
T1S<- data %>%
  filter(country=="SI", year==2019) %>% 
  pull(Tx)
T2S<- data %>%
  filter(country=="SI", year==2020) %>% 
  pull(Tx)
```

Now we can calculate each component

```{r}
LAG<- length(l1S)

# Direct effect
DES<-(l1S/l1S[1])*((L2S/l2S)-(L1S/l1S))
# Indirect effect
IES<-(T2S[-1]/l1S[1])*(((l1S[-LAG]*l2S[-1])/(l1S[-1]*l2S[-LAG]))-1)
# one extra value for the indirect component
# since there is only direct component in the last age group
IES<-c(IES,0)

# Interaction effect
OES <- (T2S[-1]/l1S[1])*((l1S[-LAG]/l2S[-LAG])-(l1S[-1]/l2S[-1]))
OES<-c(OES,0)
IS <- OES - IES
```

How do you interpret each component? What does the interaction component tell us?

Let's check our results by comparing them with the actual difference between the two life expectancies.

```{r}
## add both to get the overall age-decomposition
ALLS<-DES+IES+IS
# check
# difference in life expectancies
data %>% filter(country=="SI",year==2020,age==0) %>% pull(ex) - 
  data %>% filter(country=="SI",year==2019,age==0) %>% pull(ex)

# sum of age-specific effects
sum(ALLS)
```

The Arriaga algorithm calls for three components. However, we get the same results  with only two components. 

```{r}
sum(DES+OES)

data %>% filter(country=="SI",year==2020,age==0) %>% pull(ex) - 
  data %>% filter(country=="SI",year==2019,age==0) %>% pull(ex)
```

Why does this happen? What does the OES component capture? Why do you think Arriaga decided to have three components instead of two?

Now let's plot our the direct effects to see which ages contributed the most.

```{r}
ggplot() +
geom_bar(aes(x = factor(unique(data$age)), y = (DES+IES)), stat = "identity")
```

Do they change a lot if we use all components?

```{r}
ggplot() +
geom_bar(aes(x = factor(unique(data$age)), y = (DES+OES)), stat = "identity")
```

Now let's try with Norway.

```{r}

l1N<- data %>%
  filter(country=="NO", year==2019) %>% 
  pull(lx)
l2N<- data %>%
  filter(country=="NO", year==2020) %>% 
  pull(lx)
d1N<- data %>%
  filter(country=="NO", year==2019) %>% 
  pull(dx)
d2N<- data %>%
  filter(country=="NO", year==2020) %>% 
  pull(dx)
L1N<- data %>%
  filter(country=="NO", year==2019) %>% 
  pull(Lx)
L2N<- data %>%
  filter(country=="NO", year==2020) %>% 
  pull(Lx)
T1N<- data %>%
  filter(country=="NO", year==2019) %>% 
  pull(Tx)
T2N<- data %>%
  filter(country=="NO", year==2020) %>% 
  pull(Tx)

# Let's calculate each component
LAG<- length(l1N)

# Direct effect
DEN<-(l1N/l1N[1])*((L2N/l2N)-(L1N/l1N))
# Indirect effect
IEN<-(T2N[-1]/l1N[1])*(((l1N[-LAG]*l2N[-1])/(l1N[-1]*l2N[-LAG]))-1)
# one extra value for the indirect component
# since there is only direct component in the last age group
IEN<-c(IEN,0)

# Interaction effect
OEN <- (T2N[-1]/l1N[1])*((l1N[-LAG]/l2N[-LAG])-(l1N[-1]/l2N[-1]))
OEN<-c(OEN,0)
IN <- OEN - IEN

# Let's check the results
ALLN<-DEN+IEN+IN

# difference in life expectancies
data %>% filter(country=="NO",year==2020,age==0) %>% pull(ex) - 
  data %>% filter(country=="NO",year==2019,age==0) %>% pull(ex)

# With three components
sum(ALLN)

# With two components
sum(DEN+OEN)
```
Now we can plot the results for Norway
```{r}
ggplot() +
geom_bar(aes(x = factor(unique(data$age)), y = (DEN+IEN)), stat = "identity")

ggplot() +
geom_bar(aes(x = factor(unique(data$age)), y = (DEN+OEN)), stat = "identity")
```

What are the differences between Slovenia and Norway? How can we explain the differences in life expectancy changes between the two countries between 2019 and 2020?